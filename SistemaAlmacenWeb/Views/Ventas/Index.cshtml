@{
    ViewData["Title"] = "Punto de Venta";
}

<div class="row">
    <!-- COLUMNA IZQUIERDA: CONTROLES -->
    <div class="col-lg-4 mb-3">
        <div class="card p-3 shadow-sm h-100 border-0">

            <h4 class="text-primary mb-3"><i class="fas fa-cash-register me-2"></i> Nueva Venta</h4>

            <div class="form-group mb-4">
                <label class="text-muted small fw-bold mb-1">CLIENTE</label>
                <div class="input-group">
                    <select id="cmbCliente" class="form-select" asp-items="ViewBag.IdCliente"></select>
                    <button class="btn btn-outline-secondary" type="button" onclick="window.open('/Clientes/Create', '_blank')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <hr />

            <div class="form-group mb-3">
                <label class="text-muted small fw-bold mb-1">BUSCAR ARTÍCULO</label>
                <select id="cmbArticulo" class="form-select" asp-items="ViewBag.IdArticulo">
                    <option value="">-- Seleccione --</option>
                </select>
            </div>

            <div class="row">
                <div class="col-6 mb-3">
                    <label class="text-muted small">Precio</label>
                    <input type="text" id="txtPrecio" class="form-control text-end bg-light" readonly />
                </div>
                <div class="col-6 mb-3">
                    <label class="text-muted small">Stock</label>
                    <input type="text" id="txtStock" class="form-control text-center bg-light" readonly />
                </div>
            </div>

            <div class="form-group mb-4">
                <label class="text-muted small fw-bold mb-1">CANTIDAD</label>
                <div class="input-group">
                    <button class="btn btn-outline-secondary" onclick="ajustarCant(-1)">-</button>
                    <input type="number" id="txtCantidad" class="form-control text-center fw-bold" value="1" min="1" />
                    <button class="btn btn-outline-secondary" onclick="ajustarCant(1)">+</button>
                </div>
            </div>

            <button class="btn btn-primary w-100 py-2 shadow-sm" onclick="agregarAlCarrito()">
                AGREGAR PRODUCTO <i class="fas fa-chevron-right ms-1"></i>
            </button>
        </div>
    </div>

    <!-- COLUMNA DERECHA: TICKET -->
    <div class="col-lg-8">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
                <span class="fw-bold text-dark">RESUMEN DE VENTA</span>
                <span class="badge bg-secondary" id="lblItems">0 Items</span>
            </div>

            <div class="card-body p-0 table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped align-middle mb-0">
                    <thead class="bg-light sticky-top">
                        <tr>
                            <th>Descripción</th>
                            <th class="text-center">Cant.</th>
                            <th class="text-end">Precio</th>
                            <th class="text-end">Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tablaCarrito"></tbody>
                </table>

                <div id="msgVacio" class="text-center p-5 text-muted">
                    <i class="fas fa-shopping-cart fa-3x mb-3 text-secondary opacity-25"></i>
                    <p>El carrito está vacío</p>
                </div>
            </div>

            <div class="card-footer bg-white p-4">
                <div class="d-flex justify-content-between align-items-end mb-3">
                    <span class="text-muted fw-bold">TOTAL A PAGAR</span>
                    <h1 class="text-success fw-bold m-0" id="lblTotal">$0.00</h1>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-danger" onclick="limpiarCarrito()">Limpiar</button>
                    <button class="btn btn-success flex-grow-1 shadow-sm" onclick="finalizarVenta()">
                        <i class="fas fa-check-circle me-2"></i> COBRAR
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
         // ... (La misma lógica JS de antes, solo que al pintar el HTML no uses clases 'text-white')

         // Pega aquí la lógica JS del Punto de Venta
         // Asegúrate de que en renderizarCarrito() el HTML sea así:
         /*
            `<tr>
                <td class="fw-bold text-dark">${item.nombre}</td>
                <td class="text-center">${item.cantidad}</td>
                <td class="text-end">$${item.precio.toFixed(2)}</td>
                <td class="text-end text-success fw-bold">$${item.total.toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-sm text-danger" onclick="eliminarItem(${index})"><i class="fas fa-times"></i></button>
                </td>
            </tr>`
         */

        // ... Resto de la lógica JS ...
         let carrito = [];
         let stockActual = 0;

         document.getElementById("cmbArticulo").addEventListener("change", async function() {
             let id = this.value;
             if(!id) { limpiarInputs(); return; }
             try {
                 let response = await fetch('/Ventas/GetDatosArticulo/' + id);
                 if(response.ok) {
                     let data = await response.json();
                     document.getElementById("txtPrecio").value = "$" + data.precio.toFixed(2);
                     document.getElementById("txtStock").value = data.stock;
                     stockActual = data.stock;
                     document.getElementById("txtCantidad").value = 1;
                 }
             } catch (err) { console.error(err); }
         });

         function limpiarInputs() {
             document.getElementById("txtPrecio").value = "";
             document.getElementById("txtStock").value = "";
             stockActual = 0;
             document.getElementById("txtCantidad").value = 1;
         }

         function ajustarCant(valor) {
             let input = document.getElementById("txtCantidad");
             let actual = parseInt(input.value) || 0;
             let nuevo = actual + valor;
             if (nuevo >= 1) input.value = nuevo;
         }

         function agregarAlCarrito() {
             let cmb = document.getElementById("cmbArticulo");
             let id = cmb.value;
             let texto = cmb.options[cmb.selectedIndex].text;
             let nombreProducto = texto.split('-')[0].trim();
             let cantidad = parseInt(document.getElementById("txtCantidad").value);
             let precio = parseFloat(document.getElementById("txtPrecio").value.replace('$', ''));

             if (!id || isNaN(precio)) { Swal.fire("Error", "Seleccione un producto", "warning"); return; }
             if (cantidad > stockActual) { Swal.fire("Stock", "No hay suficiente stock", "error"); return; }

             let existe = carrito.find(p => p.id === id);
             if (existe) {
                 if ((existe.cantidad + cantidad) > stockActual) { Swal.fire("Límite", "Stock insuficiente", "warning"); return; }
                 existe.cantidad += cantidad;
                 existe.total = existe.cantidad * existe.precio;
             } else {
                 carrito.push({ id, nombre: nombreProducto, precio, cantidad, total: precio * cantidad });
             }
             renderizarCarrito();
             document.getElementById("txtCantidad").value = 1;
         }

         function renderizarCarrito() {
             let tbody = document.getElementById("tablaCarrito");
             let msg = document.getElementById("msgVacio");
             tbody.innerHTML = "";
             let granTotal = 0;
             let totalItems = 0;

             if (carrito.length === 0) {
                 msg.style.display = "block";
                 document.getElementById("lblItems").innerText = "0 Items";
                 document.getElementById("lblTotal").innerText = "$0.00";
                 return;
             }
             msg.style.display = "none";

             carrito.forEach((item, index) => {
                 granTotal += item.total;
                 totalItems += item.cantidad;
                 tbody.innerHTML += `<tr><td class="fw-bold">${item.nombre}</td><td class="text-center">${item.cantidad}</td><td class="text-end">$${item.precio.toFixed(2)}</td><td class="text-end text-success fw-bold">$${item.total.toFixed(2)}</td><td class="text-center"><button class="btn btn-sm text-danger" onclick="eliminarItem(${index})"><i class="fas fa-times"></i></button></td></tr>`;
             });
             document.getElementById("lblTotal").innerText = "$" + granTotal.toFixed(2);
             document.getElementById("lblItems").innerText = totalItems + " Items";
         }

         function eliminarItem(index) { carrito.splice(index, 1); renderizarCarrito(); }
         function limpiarCarrito() { carrito = []; renderizarCarrito(); }

         async function finalizarVenta() {
             if (carrito.length === 0) return;
             let idCliente = document.getElementById("cmbCliente").value;
             const result = await Swal.fire({ title: '¿Cobrar?', icon: 'question', showCancelButton: true, confirmButtonText: 'Sí, cobrar' });

             if (result.isConfirmed) {
                 let dto = { IdCliente: parseInt(idCliente), Detalles: carrito.map(p => ({ IdArticulo: parseInt(p.id), Cantidad: p.cantidad })) };
                 let response = await fetch('/Ventas/ProcesarVenta', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dto) });
                 if (response.ok) {
                     Swal.fire("Venta Exitosa", "", "success").then(() => window.location.reload());
                 } else { Swal.fire("Error", "No se pudo procesar", "error"); }
             }
         }
    </script>
}