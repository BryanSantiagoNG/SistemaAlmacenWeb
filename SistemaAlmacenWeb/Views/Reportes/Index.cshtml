@{
    ViewData["Title"] = "Reporte de Ventas";
    string fechaInicio = DateTime.Now.ToString("yyyy-MM-01");
    string fechaFin = DateTime.Now.ToString("yyyy-MM-dd");
}

<div class="card p-4 shadow-sm border-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0 text-dark"><i class="fas fa-chart-line text-primary"></i> Reporte de Ventas</h2>
            <small class="text-muted">Generación de reportes y exportación</small>
        </div>
    </div>

    <div class="row g-3 align-items-end mb-4 bg-light p-3 rounded border">
        <div class="col-md-3">
            <label class="form-label fw-bold small text-muted">FECHA INICIO</label>
            <input type="date" id="txtInicio" class="form-control" value="@fechaInicio">
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold small text-muted">FECHA FIN</label>
            <input type="date" id="txtFin" class="form-control" value="@fechaFin">
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="cargarReporte()">
                <i class="fas fa-search me-2"></i> Consultar
            </button>
        </div>
        <div class="col-md-3">
            <button class="btn btn-success w-100" onclick="descargarExcel()">
                <i class="fas fa-file-excel me-2"></i> Exportar Excel
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Folio</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th class="text-end">Total</th>
                </tr>
            </thead>
            <tbody id="tablaReporte">
            </tbody>
            <tfoot>
                <tr class="bg-light fw-bold">
                    <td colspan="3" class="text-end">TOTAL DEL PERIODO:</td>
                    <td class="text-end text-success fs-5" id="lblGranTotal">$0.00</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            cargarReporte(); 
        });

        async function cargarReporte() {
            let inicio = document.getElementById("txtInicio").value;
            let fin = document.getElementById("txtFin").value;
            let tbody = document.getElementById("tablaReporte");

            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-3">Cargando... <i class="fas fa-spinner fa-spin"></i></td></tr>';

            try {
                let response = await fetch(`/Reportes/FiltrarVentas?fechaInicio=${inicio}&fechaFin=${fin}`);
                let datos = await response.json();

                tbody.innerHTML = "";
                let granTotal = 0;

                if(datos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No se encontraron ventas en este periodo.</td></tr>';
                    document.getElementById("lblGranTotal").innerText = "$0.00";
                    return;
                }

                datos.forEach(d => {
                    granTotal += d.total;
                    tbody.innerHTML += `
                        <tr>
                            <td><span class="badge bg-light text-dark border">#${d.folio}</span></td>
                            <td>${d.fecha}</td>
                            <td>${d.cliente}</td>
                            <td class="text-end fw-bold text-success">$${d.total.toFixed(2)}</td>
                        </tr>
                    `;
                });

                document.getElementById("lblGranTotal").innerText = "$" + granTotal.toFixed(2);

            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al consultar datos.</td></tr>';
            }
        }

        function descargarExcel() {
            let inicio = document.getElementById("txtInicio").value;
            let fin = document.getElementById("txtFin").value;
            window.location.href = `/Reportes/DescargarExcel?fechaInicio=${inicio}&fechaFin=${fin}`;
        }
    </script>
}