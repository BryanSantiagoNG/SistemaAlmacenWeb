@{
    ViewData["Title"] = "Nuevo Pedido";
}

<div class="row">
    <div class="col-md-4">
        <div class="card p-4 mb-3 shadow-sm border-0">
            <h4 class="card-title text-primary mb-4"><i class="fas fa-file-invoice me-2"></i> Datos del Pedido</h4>

            <div class="form-group mb-3">
                <label class="control-label fw-bold text-dark mb-1">1. Seleccione Proveedor</label>
                <select id="cmbProveedor" class="form-select" asp-items="ViewBag.IdProveedor">
                    <option value="">-- Seleccione --</option>
                </select>
            </div>

            <hr class="text-muted my-4" />

            <h5 class="text-secondary mb-3">2. Agregar Producto</h5>

            <div class="form-group mb-3">
                <label class="form-label text-muted small fw-bold">ARTÍCULO</label>
                <select id="cmbArticulo" class="form-select" disabled>
                    <option value="">-- Primero elija un proveedor --</option>
                </select>
            </div>

            <div class="row">
                <div class="col-6 mb-2">
                    <label class="form-label text-muted small fw-bold">COSTO UNIT.</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light text-muted">$</span>
                        <input type="number" id="txtCosto" class="form-control" step="0.01" />
                    </div>
                </div>
                <div class="col-6 mb-2">
                    <label class="form-label text-muted small fw-bold">CANTIDAD</label>
                    <input type="number" id="txtCantidad" class="form-control" value="1" min="1" />
                </div>
            </div>

            <button class="btn btn-primary w-100 mt-4 fw-bold shadow-sm" onclick="agregarProducto()">
                <i class="fas fa-plus-circle me-1"></i> Agregar a la Lista
            </button>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card p-4 h-100 shadow-sm border-0">
            <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-3">
                <h4 class="card-title text-dark mb-0">Detalle de Compra</h4>
                <div class="text-end">
                    <small class="text-muted d-block">Total Estimado</small>
                    <h2 class="text-success fw-bold m-0" id="lblTotal">$0.00</h2>
                </div>
            </div>

            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>Producto</th>
                            <th>Costo</th>
                            <th class="text-center">Cant.</th>
                            <th class="text-end">Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tablaDetalles">
                    </tbody>
                </table>

                <div id="msgVacio" class="text-center p-5 text-muted">
                    <i class="fas fa-shopping-basket fa-3x mb-3 opacity-25"></i>
                    <p>Agregue productos a la lista</p>
                </div>
            </div>

            <div class="mt-auto pt-3 border-top">
                <button class="btn btn-success btn-lg w-100 shadow fw-bold" onclick="guardarPedido()">
                    <i class="fas fa-save me-2"></i> FINALIZAR PEDIDO
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let listaProductos = [];

        document.getElementById("cmbProveedor").addEventListener("change", async function() {
            let idProv = this.value;
            let cmbArt = document.getElementById("cmbArticulo");

            cmbArt.innerHTML = '<option value="">Cargando...</option>';
            cmbArt.value = "";
            document.getElementById("txtCosto").value = "";

            if (!idProv) {
                cmbArt.innerHTML = '<option value="">-- Primero elija un proveedor --</option>';
                cmbArt.disabled = true;
                return;
            }

            try {
                let response = await fetch(`/Pedidos/GetArticulosPorProveedor?idProveedor=${idProv}`);
                let articulos = await response.json();

                cmbArt.innerHTML = '<option value="">-- Seleccione Artículo --</option>';

                if (articulos.length === 0) {
                    cmbArt.innerHTML = '<option value="">Este proveedor no tiene artículos</option>';
                } else {
                    articulos.forEach(art => {
                        let option = document.createElement("option");
                        option.value = art.id;
                        option.text = art.nombre;
                        option.setAttribute("data-precio", art.precio);
                        cmbArt.appendChild(option);
                    });
                    cmbArt.disabled = false;
                }
            } catch (error) {
                console.error(error);
                cmbArt.innerHTML = '<option value="">Error al cargar</option>';
            }
        });

        document.getElementById("cmbArticulo").addEventListener("change", function() {
            let precio = this.options[this.selectedIndex].getAttribute("data-precio");
            if (precio) {
                document.getElementById("txtCosto").value = parseFloat(precio).toFixed(2);
            } else {
                document.getElementById("txtCosto").value = "";
            }
        });

        function agregarProducto() {
            let cmbArt = document.getElementById("cmbArticulo");
            let idArticulo = cmbArt.value;
            let nombreArt = cmbArt.options[cmbArt.selectedIndex].text;
            let costo = parseFloat(document.getElementById("txtCosto").value);
            let cantidad = parseInt(document.getElementById("txtCantidad").value);

            if (!idArticulo || isNaN(costo) || isNaN(cantidad) || cantidad < 1) {
                Swal.fire({ title: "Datos incompletos", text: "Verifique la información", icon: "warning" });
                return;
            }

            let existente = listaProductos.find(p => p.id === idArticulo);
            if (existente) {
                existente.cantidad += cantidad;
                existente.subtotal = existente.cantidad * existente.costo;
            } else {
                listaProductos.push({
                    id: idArticulo,
                    nombre: nombreArt.split('-')[1] || nombreArt,
                    costo: costo,
                    cantidad: cantidad,
                    subtotal: costo * cantidad
                });
            }

            renderizarTabla();

            cmbArt.value = "";
            document.getElementById("txtCosto").value = "";
            document.getElementById("txtCantidad").value = "1";
            cmbArt.focus();
        }

        function renderizarTabla() {
            let tbody = document.getElementById("tablaDetalles");
            let msg = document.getElementById("msgVacio");
            tbody.innerHTML = "";
            let total = 0;

            if (listaProductos.length === 0) {
                msg.style.display = "block";
            } else {
                msg.style.display = "none";
            }

            listaProductos.forEach((item, index) => {
                total += item.subtotal;
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-dark">${item.nombre}</td>
                        <td>$${item.costo.toFixed(2)}</td>
                        <td class="text-center">${item.cantidad}</td>
                        <td class="fw-bold text-success text-end">$${item.subtotal.toFixed(2)}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="eliminarFila(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById("lblTotal").innerText = "$" + total.toFixed(2);
        }

        function eliminarFila(index) {
            listaProductos.splice(index, 1);
            renderizarTabla();
        }

        async function guardarPedido() {
            let idProv = document.getElementById("cmbProveedor").value;

            if (listaProductos.length === 0) {
                Swal.fire("Carrito vacío", "Agregue productos primero", "warning");
                return;
            }

            let datosDTO = {
                IdProveedor: parseInt(idProv),
                Detalles: listaProductos.map(p => ({
                    IdArticulo: parseInt(p.id),
                    Cantidad: p.cantidad,
                    PrecioUnitario: p.costo
                }))
            };

            try {
                let response = await fetch('/Pedidos/ConfirmarPedido', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosDTO)
                });

                if (response.ok) {
                    Swal.fire({
                        title: "¡Pedido Guardado!",
                        text: "Inventario actualizado correctamente.",
                        icon: "success",
                        confirmButtonColor: '#0d6efd'
                    }).then(() => {
                        window.location.href = "/Home/Index";
                    });
                } else {
                    let text = await response.text();
                    Swal.fire("Error", text, "error");
                }
            } catch (err) {
                console.error(err);
                Swal.fire("Error", "Fallo de conexión", "error");
            }
        }
    </script>
}